var documenterSearchIndex = {"docs":
[{"location":"01-installation/#installation","page":"Installation","title":"Installing TethysChloris.jl","text":"To use the TethysChloris package, you can install it by cloning it from its GitHub repository and adding it to your Julia environment. ","category":"section"},{"location":"01-installation/#Cloning-the-repository","page":"Installation","title":"Cloning the repository","text":"In your terminal, run the following command to clone the repository:\n\ngit clone https://github.com/CHANGE-EPFL/TethysChloris.jl.git \n\nThis will create a local copy of the TethysChloris.jl repository on your machine, along with all its history. Most of the time, this may be unnecessary, as you are likely only interested in using the latest version of the package.\n\nTo only clone the latest version, without the full history, you can use the --depth 1 option:\n\nNote: Replace <latest-tag> with the latest release tag from the releases page.\n\ngit clone --depth 1 --branch <latest-tag> https://github.com/CHANGE-EPFL/TethysChloris.jl.git","category":"section"},{"location":"01-installation/#Adding-the-package-to-your-Julia-environment","page":"Installation","title":"Adding the package to your Julia environment","text":"Open Julia's REPL, and run the following commands to add the package:\n\nusing Pkg\nPkg.develop(path=\"TethysChloris.jl\")\n\nPlease note that the first installation may take up to 15 minutes as Julia will download and compile all the necessary dependencies for the package.","category":"section"},{"location":"04-plots/#plots","page":"Plotting the results","title":"Plotting the simulation results","text":"Following the execution of the TethysChloris.jl model, you may want to visualize the results to better understand the model's behavior and outputs. The package provides a set of plotting functions that can be used to create various types of plots based on the simulation results.","category":"section"},{"location":"04-plots/#Plotting-Functions","page":"Plotting the results","title":"Plotting Functions","text":"The plotting functions are designed to work with the model's output data. You can use these functions to create plots of different variables, such as soil moisture, vegetation growth, and other biogeochemical parameters.","category":"section"},{"location":"04-plots/#Example-of-Plotting","page":"Plotting the results","title":"Example of Plotting","text":"To plot the results of your model simulation, you can follow these steps:\n\nusing TethysChloris.Figures\n\nplot_meteorological(model, NN)\nplot_soil_moisture(model, NN)\nplot_evaporation_transpiration(model, NN)\nplot_temperature_fluxes(model, NN)\nplot_resistances(model, NN)\nplot_stomatal_resistances(model, NN)\nplot_interception(model, NN)\nplot_daily_transpiration(model, NN)\nplot_precipitation_drainage(model, NN)\nplot_water_fluxes(model, NN)\nplot_soil_water_depths(model, NN)\nplot_water_table(model, NN)\n\n# snow plots\nplot_snow_coverage(model, NN)\nplot_snow_characteristics(model, NN)\nplot_snowpack_water(model, NN)\nplot_snow_water(model, NN)\n\n# ice plots\nplot_ice(model, NN)\nplot_ice_water(model, NN)\n\ncc = 1\n\n# vegetation plots\nfor k = 1:cc\n    plot_assimilation(model, NN, k)\n    plot_vegetation_dynamics(model, NNd, k)\n    plot_phenology(model, NNd, k)\n    plot_carbon_pools(model, NNd, k)\n    plot_beta_factors(model, NNd, k)\nend","category":"section"},{"location":"91-developer/#dev_docs","page":"Developer","title":"Developer documentation","text":"note: Contributing guidelines\nIf you haven't, please read the Contributing guidelines first.\n\nIf you want to make contributions to this package that involves code, then this guide is for you.","category":"section"},{"location":"91-developer/#First-time-clone","page":"Developer","title":"First time clone","text":"tip: If you have writing rights\nIf you have writing rights, you don't have to fork. Instead, simply clone and skip ahead. Whenever upstream is mentioned, use origin instead.\n\nIf this is the first time you work with this repository, follow the instructions below to clone the repository.\n\nFork this repo\nClone your repo with submodules (this will create a git remote called origin):\nbash  git clone --recurse-submodules <your-repo-url>\nAdd this repo as a remote:\ngit remote add upstream https://github.com/CHANGE-EPFL/TethysChloris.jl\n\nThis will ensure that you have two remotes in your git: origin and upstream. You will create branches and push to origin, and you will fetch and update your local main branch from upstream.\n\nIf you cloned the repo without submodules, you can run the following command to get the submodules:\n\n  git submodule update --init --recursive\n  ```\n\n## Linting and formatting\n\nInstall a plugin on your editor to use [EditorConfig](https://editorconfig.org).\nThis will ensure that your editor is configured with important formatting settings.\n\nWe use [https://pre-commit.com](https://pre-commit.com) to run the linters and formatters.\nIn particular, the Julia code is formatted using [JuliaFormatter.jl](https://github.com/domluna/JuliaFormatter.jl), so please install it globally first:\n\n\njulia-repl julia> # Press ] pkg> activate pkg> add JuliaFormatter\n\n\nTo install `pre-commit`, we recommend using [pipx](https://pipx.pypa.io) as follows:\n\n\nbash","category":"section"},{"location":"91-developer/#Install-pipx-following-the-link","page":"Developer","title":"Install pipx following the link","text":"pipx install pre-commit\n\n\nWith `pre-commit` installed, activate it as a pre-commit hook:\n\n\nbash pre-commit install\n\n\nTo run the linting and formatting manually, enter the command below:\n\n\nbash pre-commit run -a\n\n\n**Now, you can only commit if all the pre-commit tests pass**.\n\n## Testing\n\nAs with most Julia packages, you can just open Julia in the repository folder, activate the environment, and run `test`:\n\n\njulia-repl julia> # press ] pkg> activate . pkg> test ```","category":"section"},{"location":"91-developer/#Working-on-a-new-issue","page":"Developer","title":"Working on a new issue","text":"We try to keep a linear history in this repo, so it is important to keep your branches up-to-date.\n\nFetch from the remote and fast-forward your local main\ngit fetch upstream\ngit switch main\ngit merge --ff-only upstream/main\nBranch from main to address the issue (see below for naming)\ngit switch -c 42-add-answer-universe\nPush the new local branch to your personal remote repository\ngit push -u origin 42-add-answer-universe\nCreate a pull request to merge your remote branch into the org main.","category":"section"},{"location":"91-developer/#Branch-naming","page":"Developer","title":"Branch naming","text":"If there is an associated issue, add the issue number.\nIf there is no associated issue, and the changes are small, add a prefix such as \"typo\", \"hotfix\", \"small-refactor\", according to the type of update.\nIf the changes are not small and there is no associated issue, then create the issue first, so we can properly discuss the changes.\nUse dash separated imperative wording related to the issue (e.g., 14-add-tests, 15-fix-model, 16-remove-obsolete-files).","category":"section"},{"location":"91-developer/#Commit-message","page":"Developer","title":"Commit message","text":"Use imperative or present tense, for instance: Add feature or Fix bug.\nHave informative titles.\nWhen necessary, add a body with details.\nIf there are breaking changes, add the information to the commit message.","category":"section"},{"location":"91-developer/#Before-creating-a-pull-request","page":"Developer","title":"Before creating a pull request","text":"tip: Atomic git commits\nTry to create \"atomic git commits\"\n\nMake sure the tests pass.\nMake sure the pre-commit tests pass.\nFetch any main updates from upstream and rebase your branch, if necessary:\ngit fetch upstream\ngit rebase upstream/main BRANCH_NAME\nThen you can open a pull request and work with the reviewer to address any issues.","category":"section"},{"location":"91-developer/#Building-and-viewing-the-documentation-locally","page":"Developer","title":"Building and viewing the documentation locally","text":"Following the latest suggestions, we recommend using LiveServer to build the documentation. Here is how you do it:\n\nRun julia --project=docs to open Julia in the environment of the docs.\nIf this is the first time building the docs\nPress ] to enter pkg mode\nRun pkg> dev . to use the development version of your package\nPress backspace to leave pkg mode\nRun julia> using LiveServer\nRun julia> servedocs()","category":"section"},{"location":"91-developer/#Making-a-new-release","page":"Developer","title":"Making a new release","text":"To create a new release, you can follow these simple steps:\n\nCreate a branch release-x.y.z\nUpdate version in Project.toml\nUpdate the CHANGELOG.md:\nRename the section \"Unreleased\" to \"[x.y.z] - yyyy-mm-dd\" (i.e., version under brackets, dash, and date in ISO format)\nAdd a new section on top of it named \"Unreleased\"\nAdd a new link in the bottom for version \"x.y.z\"\nChange the \"[unreleased]\" link to use the latest version - end of line, vx.y.z ... HEAD.\nCreate a commit \"Release vx.y.z\", push, create a PR, wait for it to pass, merge the PR.\nGo back to main screen and click on the latest commit (link: https://github.com/CHANGE-EPFL/TethysChloris.jl/commit/main)\nAt the bottom, write @JuliaRegistrator register\n\nAfter that, you only need to wait and verify:\n\nWait for the bot to comment (should take < 1m) with a link to a RP to the registry\nFollow the link and wait for a comment on the auto-merge\nThe comment should said all is well and auto-merge should occur shortly\nAfter the merge happens, TagBot will trigger and create a new GitHub tag. Check on https://github.com/CHANGE-EPFL/TethysChloris.jl/releases\nAfter the release is create, a \"docs\" GitHub action will start for the tag.\nAfter it passes, a deploy action will run.\nAfter that runs, the stable docs should be updated. Check them and look for the version number.","category":"section"},{"location":"02-inputs/#inputs","page":"Input file formats","title":"Preparing the model inputs","text":"TethysChloris.jl requires two specific input files to run the model: a configuration file and a forcing file. These files are essential for defining the model's parameters and the environmental conditions under which it operates.\n\nThe configuration file is a YAML file that contains various parameters necessary for the model's operation. The dictionary will be used to initialize the model parameters. As such, most of the contents of the YAML file comes from the MOD_PARAM_* files in the original MATLAB code. When functions were used in the MOD_PARAM_* files, the corresponding Julia function are used directly during the creation of the model parameters. This is the case for Soil_parameters and Soil_parametersII.\n\nThe forcing file is a NetCDF file that provides the environmental data needed for the model. The NetCDF file is created using a mixture of the MOD_PARAM_* files and the MAT files associated with the original MATLAB code, as well as some hard-coded initialization values.\n\nThe data-raw/create_input_data.jl script is an example of how to create these input files from the original MATLAB data. This script is designed to generate the necessary input files in the correct format for TethysChloris.jl.","category":"section"},{"location":"02-inputs/#input_details","page":"Input file formats","title":"Detailed preparation of the model inputs","text":"To run TethysChloris.jl, you need to create two essential input files:","category":"section"},{"location":"02-inputs/#A-YAML-configuration-file-containing-model-parameters","page":"Input file formats","title":"A YAML configuration file containing model parameters","text":"","category":"section"},{"location":"02-inputs/#A-NetCDF-file-with-forcing-data-and-initial-conditions-for-the-state-and-auxiliary-variables","page":"Input file formats","title":"A NetCDF file with forcing data and initial conditions for the state and auxiliary variables","text":"Below are step-by-step instructions for creating these files from meteorological data.","category":"section"},{"location":"02-inputs/#input_requirements","page":"Input file formats","title":"Requirements","text":"You'll need the following Julia packages:\n\nNCDatasets.jl for handling NetCDF files\nYAML.jl for creating YAML configuration files\nDates for date manipulation\nMAT.jl for reading MATLAB .mat files (if using MATLAB data sources)\n\nThese packages can be installed using Julia's package manager:\n\nusing Pkg\nPkg.add(\"NCDatasets\")\nPkg.add(\"YAML\")\nPkg.add(\"Dates\")\nPkg.add(\"MAT\")","category":"section"},{"location":"02-inputs/#input_sources","page":"Input file formats","title":"Step 1: Data Sources","text":"Your meteorological forcing data should include the following hourly variables:\n\nDate and time (as a single Vector{DateTime} object)\nTemperature (Ta)\nPrecipitation (Pr)\nWind speed (Ws)\nVapor pressure (ea)\nSolar radiation components (SAD1, SAD2, SAB1, SAB2)\nDew point temperature (Tdew)\nSaturation vapor pressure (esat)\nPhotosynthetically active radiation (PARB, PARD)\nCO2 concentration (Ca)","category":"section"},{"location":"02-inputs/#input_yaml","page":"Input file formats","title":"Step 2: YAML File","text":"The YAML configuration file contains several parameter groups. Please note that some parameters that were explicitly calculated in the MATLAB MOD_PARAM_* files are now computed directly in the Julia composite types during model initialization.","category":"section"},{"location":"02-inputs/#Basic-parameters","page":"Input file formats","title":"Basic parameters","text":"Zs = FT.([0, 10, 20, 50, 100, 150, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1350, 1500])\nn_layers = length(Zs) - 1\n\ndata = Dict{String,Any}()\ndata[\"n_layers\"] = n_layers","category":"section"},{"location":"02-inputs/#Cell-properties","page":"Input file formats","title":"Cell properties","text":"data[\"cell\"] = Dict{String,Any}(\n    \"cellsize\" => 1.0,\n    \"SvF\" => 1.0,\n    \"SN\" => 0.0,\n    \"Slo_top\" => 0.0,\n    \"Ared\" => 1.0,\n    \"aR\" => 1.0,\n)\n\nThe Asur, Slo_pot, aTop, cosalp, sinalp and aTop_scaled parameters are now calculated internally based on the cellsize and Slo_top parameters.","category":"section"},{"location":"02-inputs/#Simulation-settings","page":"Input file formats","title":"Simulation settings","text":"data[\"simulation\"] = Dict{String,Any}(\n    \"Zs\" => Zs,\n    \"dt\" => 3600,\n    \"dtd\" => 1,\n    \"Lon\" => -120.9508,\n    \"Lat\" => 38.4133,\n    \"DeltaGMT\" => -8,\n    \"t_bef\" => 0.25,\n    \"t_aft\" => 0.75,\n    \"Zdes\" => 10.0,\n    \"Zinf\" => 10.0,\n    \"Zbio\" => 250.0,\n    \"SPAR\" => 2,\n    \"fpr\" => 1.0,\n    \"CASE_ROOT\" => 1,\n    \"zatm\" => 2.0,\n    \"timerange\" => [DateTime(2011, 10, 1, 0, 0), DateTime(2017, 9, 30, 23, 0)],\n    \"SPAR\" => 2,\n  )\n\nThe timerange parameter allows the user to specify the start and end dates for the simulation. The ms, dth, dz, Dz, EvL_Zs, Inf_Zs, Bio_Zs, timesteps and days parameters are now calculated internally based on the Zs, Zdes, Zinf, Zbio, dth, and timerange parameters.","category":"section"},{"location":"02-inputs/#Land-cover-information","page":"Input file formats","title":"Land cover information","text":"data[\"landcover\"] = Dict{String,Any}(\n    \"Cbare\" => 0.0,\n    \"Cwat\" => 0.0,\n    \"Curb\" => 0.0,\n    \"Crock\" => 0.0,\n    \"Ccrown\" => [1.0],\n)","category":"section"},{"location":"02-inputs/#Soil-properties","page":"Input file formats","title":"Soil properties","text":"data[\"soil\"] = Dict{String,Any}(\n    \"Pcla\" => 0.13,\n    \"Psan\" => 0.30,\n    \"Porg\" => 0.0139,\n    \"Kfc\" => 0.2,\n    \"Phy\" => 10000.0,\n    \"color_class\" => 0,\n)\n\nThe following parameters are now calculated internally using the soil_parameters and Soil_parametersII functions based on the Pcla, Psan, Porg, Kfc and Phy parameters:\n\nKs_Zs\nOsat\nOhy\nL\nPe\nO33\nalpVG\nnVG\nKs_mac\nOmac\nalpVGM\nnVGM\nrsd\nlan_dry\nlan_s\ncv_s\ns_SVG\nbVG\nlVG\nlVGM\nOfc\nK_usle","category":"section"},{"location":"02-inputs/#Debris-cover-parameters","page":"Input file formats","title":"Debris cover parameters","text":"data[\"debris\"] = Dict{String,Any}(\n    \"alb\" => 0.13,\n    \"e_sur\" => 0.94,\n    \"lan\" => 0.94,\n    \"rho\" => 1496.0,\n    \"cs\" => 948.0,\n    \"zom\" => 0.016,\n    \"dbThick\" => 0.0,\n)","category":"section"},{"location":"02-inputs/#Rock-parameters","page":"Input file formats","title":"Rock parameters","text":"data[\"rock\"] = Dict{String,Any}(\n    \"Kbot\" => NaN64,\n    \"Krock\" => NaN64,\n    \"In_max_rock\" => 0.1\n)","category":"section"},{"location":"02-inputs/#Snow-and-ice-parameters","page":"Input file formats","title":"Snow and ice parameters","text":"data[\"snowice\"] = Dict{String,Any}(\n    \"TminS\" => -0.8,\n    \"TmaxS\" => 2.8,\n    \"WatFreez_Th\" => -8.0,\n    \"dz_ice\" => 0.45,\n    \"Th_Pr_sno\" => 8.0,\n    \"ros_max1\" => 550.0,\n    \"ros_max2\" => 300.0,\n    \"Ice_wc_sp\" => 0.01,\n    \"ros_ice_thr\" => 500.0,\n    \"Aice\" => 0.28,\n    \"dir_vis\" => 0.2,\n    \"dif_vis\" => 0.2,\n    \"dir_nir\" => 0.2,\n    \"dif_nir\" => 0.2,\n    \"Sp_SN_In\" => 5.9,\n)","category":"section"},{"location":"02-inputs/#Urban-parameters","page":"Input file formats","title":"Urban parameters","text":"data[\"urban\"] = Dict{String,Any}(\n    \"alb\" => 0.15,\n    \"e_sur\" => 0.92,\n    \"BuildH\" => 12.0,\n    \"In_max_urb\" => 5.0\n)","category":"section"},{"location":"02-inputs/#Vegetation-parameters","page":"Input file formats","title":"Vegetation parameters","text":"data[\"vegetation\"] = Dict{String, Any}(\n    \"gcI\" => 3.7,\n    \"KcI\" => 0.06,\n    \"Kct\" => 0.75,\n    \"Sllit\" => 2.0,\n    \"Oa\" => 210000.0,\n)\n\ndata[\"vegetation\"][\"high\"] = Dict{String,Any}(\n    \"ZRmax\" => [NaN64],\n    \"ZR50\" => [NaN64],\n    \"Knit\" => [0.2],\n    \"mSl\" => [0.0],\n    \"FI\" => [0.081],\n    \"Do\" => [1000.0],\n    \"a1\" => [7.0],\n    \"go\" => [0.01],\n    \"CT\" => [3],\n    \"DSE\" => [0.649],\n    \"Ha\" => [72.0],\n    \"gmes\" => [Inf64],\n    \"rjv\" => [2.8],\n    \"Vmax\" => [0.0],\n    \"Psi_sto_00\" => [-0.5],\n    \"Psi_sto_50\" => [-2.0],\n    \"PsiL00\" => [-2.7],\n    \"PsiL50\" => [-5.6],\n    \"PsiX50\" => [-3.5],\n    \"Kleaf_max\" => [5.0],\n    \"Cl\" => [1200.0],\n    \"Axyl\" => [15.0],\n    \"Kx_max\" => [80000.0],\n    \"Cx\" => [150.0],\n    \"Sl\" => [0.016],\n    \"Osm_reg_Max\" => [0.0],\n    \"eps_root_base\" => [0.9],\n    \"d_leaf\" => [3.5],\n    \"Sp_LAI_In\" => [0.2],\n    \"OM\" => 1.0,\n    \"PFT_Class\" => [0],\n)\n\ndata[\"vegetation\"][\"low\"] = Dict{String,Any}(\n    ...\n)\n\nAll parameters with bracketed values require one value per crown area. data[\"vegetation\"][\"low\"] can be filled similarly with low vegetation parameters.","category":"section"},{"location":"02-inputs/#Vegetation-dynamics","page":"Input file formats","title":"Vegetation dynamics","text":"The vegetation dynamics parameters are created as a vector of Dict, with one Dict per crown area.\n\ndata[\"vegetationdynamics\"] = Dict{String,Any}()\ndata[\"vegetationdynamics\"][\"high\"] = [Dict{String,Any}(\n      \"Sl\" => 0.016,\n      \"mSl\" => 0.0,\n      \"r\" => 0.030,\n      \"gR\" => 0.25,\n      \"LtR\" => 1.0,\n      \"eps_ac\" => 1.0,\n      \"aSE\" => 5,\n      \"Trr\" => 3.5,\n      \"dd_max\" => 1/365,\n      \"dc_C\" => 2/365,\n      \"Tcold\" => 7.0,\n      \"drn\" => 1/1095,\n      \"dsn\" => 1/365,\n      \"age_cr\" => 150.0,\n      \"Bfac_lo\" => 0.95,\n      \"Bfac_ls\" => NaN64,\n      \"Tlo\" => 12.9,\n      \"Tls\" => NaN64,\n      \"mjDay\" => 180,\n      \"LDay_min\" => 11.0,\n      \"dmg\" => 35.0,\n      \"Mf\" => 1/50,\n      \"Wm\" => 1/16425,\n      \"LAI_min\" => 0.01,\n      \"LDay_cr\" => 12.30,\n      \"PsiG50\" => -0.45,\n      \"PsiG99\" => -1.2,\n      \"gcoef\" => 3.5,\n      \"Klf\" => 1/15,\n      \"fab\" => 0.74,\n      \"fbe\" => 0.26,\n      \"ff_r\" => 0.1,\n      \"PAR_th\" => NaN64,\n      \"PsiL50\" => -5.6,\n      \"PsiL00\" => -2.7,\n      \"Nl\" => 30.0,\n)]\n\ndata[\"vegetationdynamics\"][\"low\"] = [Dict{String,Any}(\n    ...\n)]","category":"section"},{"location":"02-inputs/#Vegetation-management","page":"Input file formats","title":"Vegetation management","text":"data[\"vegetationmanagement\"] = Dict{String,Any}(\n    \"high\" => [\n        Dict{String,Any}(\n            \"LAI_cut\" => 0.0,\n            \"B_harv\" => 0.0,\n            \"fract_log\" => 0.0,\n            \"fire_eff\" => 0.0,\n            \"funb_nit\" => 0.15,\n            \"fract_girdling\" => 0.0,\n            \"Crop_B\" => [0.0, 0.0],\n            \"Crop_crown\" => 1.0,\n            \"fract_resprout\" => 0.2,\n            \"fract_left\" => 1.0,\n            \"fract_left_fr\" => 0.0,\n            \"fract_left_AB\" => 0.0,\n            \"fract_left_BG\" => 1.0,\n        ),\n    ],\n)\n\ndata[\"vegetationmanagement\"][\"low\"] = data[\"vegetationmanagement\"][\"high\"]\ndata[\"vegetationmanagement\"][\"low\"][1][\"jDay_cut\"] = [132, 168, 202, 238, 292]\ndata[\"vegetationmanagement\"][\"low\"][1][\"LAI_cut\"] = 1.68","category":"section"},{"location":"02-inputs/#Exudation-parameters","page":"Input file formats","title":"Exudation parameters","text":"data[\"exudation\"] = Dict{String,Any}(\n    \"high\" => [Dict{String,Any}(\"bfix\" => false)],\n    \"low\" => [Dict{String,Any}(\"bfix\" => false)],\n)","category":"section"},{"location":"02-inputs/#Biogeochemistry-parameters","page":"Input file formats","title":"Biogeochemistry parameters","text":"data[\"biogeochemistry\"] = Dict{String,Any}(\"PH\" => 5.0, \"ExEM\" => 0.0)\n\ndata[\"biogeochemistry_io\"] = Dict{String,Any}(\n    \"SC_par\" => [1.0, 1.0, 1.0, 1.0],\n    \"Upl\" => 0.01,\n    \"HIST\" => false\n)","category":"section"},{"location":"02-inputs/#Save-the-YAML-configuration","page":"Input file formats","title":"Save the YAML configuration","text":"YAML.write_file(\"your_site_parameters.yaml\", data)","category":"section"},{"location":"02-inputs/#input_netcdf","page":"Input file formats","title":"Step 3: NetCDF File","text":"The NetCDF file contains both forcing data and initial conditions. The NCDatasets can be used to create and manipulate NetCDF files in Julia, via the defGroup, defDim, and defVar functions. Before creating the initial conditions, the dimensions must be defined. Similarly, for height-dependent variables, the high and low vegetation groups must be created first.","category":"section"},{"location":"02-inputs/#Initialize-the-NetCDF-file","page":"Input file formats","title":"Initialize the NetCDF file","text":"ds = NCDataset(\"your_site_data.nc\", \"c\")\n\nhigh_vegetation = defGroup(ds, \"high_vegetation\")\nlow_vegetation = defGroup(ds, \"low_vegetation\")","category":"section"},{"location":"02-inputs/#Define-dimensions","page":"Input file formats","title":"Define dimensions","text":"defDim(ds, \"crownareas\", 1)\ndefDim(ds, \"carbonpools\", 8)\ndefDim(ds, \"nutrient\", 3)\ndefDim(ds, \"layers\", length(Zs))\ndefDim(ds, \"layerbelowsurface\", n_layers)\n...","category":"section"},{"location":"02-inputs/#Add-time-variables","page":"Input file formats","title":"Add time variables","text":"defVar(ds, \"datetime\", datetime_array, (\"hours\",))","category":"section"},{"location":"02-inputs/#Add-meteorological-forcing-data","page":"Input file formats","title":"Add meteorological forcing data","text":"defVar(ds, \"Pr\", precipitation_data, (\"hours\",))\ndefVar(ds, \"Ta\", temperature_data, (\"hours\",))\ndefVar(ds, \"Ws\", wind_speed_data, (\"hours\",))\ndefVar(ds, \"ea\", vapor_pressure_data, (\"hours\",))\ndefVar(ds, \"SAD1\", sad1_data, (\"hours\",))\ndefVar(ds, \"SAD2\", sad2_data, (\"hours\",))\ndefVar(ds, \"SAB1\", sab1_data, (\"hours\",))\ndefVar(ds, \"SAB2\", sab2_data, (\"hours\",))\ndefVar(ds, \"Tdew\", tdew_data, (\"hours\",))\ndefVar(ds, \"esat\", esat_data, (\"hours\",))\ndefVar(ds, \"PARB\", parb_data, (\"hours\",))\ndefVar(ds, \"PARD\", pard_data, (\"hours\",))\ndefVar(ds, \"Ca\", co2_data, (\"hours\",))\n\n# Calculate vapor pressure deficit\nDs = max.(esat_data - vapor_pressure_data, 0)\ndefVar(ds, \"Ds\", Ds, (\"hours\",))","category":"section"},{"location":"02-inputs/#Add-soil-layer-information","page":"Input file formats","title":"Add soil layer information","text":"defVar(ds, \"Zs\", soil_depths, (\"layers\",))","category":"section"},{"location":"02-inputs/#Add-initial-conditions-for-state-and-auxiliary-variables","page":"Input file formats","title":"Add initial conditions for state and auxiliary variables","text":"For hydrologic state variables shared between high and low vegetation:\n\nO = [\n    0.3269,\n    0.328,\n    0.329,\n    0.3314,\n    0.3341,\n    0.3367,\n    0.3402,\n    0.3442,\n    0.3476,\n    0.3505,\n    0.3541,\n    0.3564,\n]\ndefVar(ds, \"O\", initial_soil_moisture, (\"layerbelowsurface\",))\ndefVar(ds, \"Tdamp\", 22.0, ())\n...\n\nFor hydrologic state variables specific to high vegetation:\n\n\ndefVar(high_vegetation, \"Ci_sun\", [Ca[1]], (\"crownareas\",))\ndefVar(high_vegetation, \"Ci_shd\", [Ca[1]], (\"crownareas\",))\ndefVar(high_vegetation, \"In\", [0.0], (\"crownareas\",))\ndefVar(high_vegetation, \"LAI_tot\", [0.0], (\"crownareas\",))\n...","category":"section"},{"location":"02-inputs/#Close-the-NetCDF-file","page":"Input file formats","title":"Close the NetCDF file","text":"close(ds)","category":"section"},{"location":"02-inputs/#input_examples","page":"Input file formats","title":"Existing Examples","text":"The create_vaira_data.jl and create_zurich_data.jl scripts in the data-raw directory provide complete examples of creating input files for specific sites. You can adapt these scripts for your own site by:\n\nReplacing the input data sources with your own meteorological data\nAdjusting site-specific parameters (location, soil properties, vegetation characteristics)\nModifying initial conditions based on your site knowledge\n\nBy following these steps, you'll be able to create the necessary input files to run TethysChloris.jl with your own site data.","category":"section"},{"location":"03-model/#model","page":"Running the model","title":"Running the model","text":"To run the TethysChloris.jl model, you need to have the input files prepared as described in the Preparing the model inputs section. Once you have the configuration and forcing files ready, you can proceed to run the model.\n\nThe model is designed to be run in a Julia environment. You can use the following steps to execute the model:\n\nOpen a Julia REPL: Start Julia in your terminal or command prompt.\nLoad the TethysChloris.jl package: Use the Julia package manager to load the TethysChloris.jl package. If you have installed it as described in the Installing TethysChloris.jl section, you can load it with:\nusing TethysChloris\nLoad the configuration and forcing files: You need to specify the paths to your configuration and forcing files. For example:\nyaml_file = \"path/to/configuration.yaml\"\nforcing_file = \"path/to/forcing.nc\"\nInitialize the model: Create an instance of the model using the two files, as well as specifying the data type (e.g., Float64):\nmodel = initialize_model(Float64, forcing_data, yaml_data)\nSpecify the model options: You can set various options for the model, in the form of a ModelOptions type. These options control different aspects of the model's behavior. For example:\noptions = ModelOptions(\n   SoilTemperature = true,\n   FreezingSoil = true,\n   VegetationSnowInteractions = true,\n   OPT_ST = ZeroFindingOptions(FT; rtol = 0.1),\n   OPT_ST2 = ZeroFindingOptions(FT; rtol = 0.1),\n   OPT_VD = ODEOptions(; abstol = 0.05),\n)\nRun the model: Finally, you can run the model with the specified options, specifying the number of time steps. For example, to run the model for 3 days, you can use:\nNNd = 3\nNN = NNd * 24\nALB, CK1, Ck, DQ = run_simulation(model; NN = NN, options = options)\n\nPlease note that the simulation results will be stored in the model instance, and you can access them for further analysis or visualization.","category":"section"},{"location":"03-model/#Specifying-model-options","page":"Running the model","title":"Specifying model options","text":"","category":"section"},{"location":"03-model/#ModelOptions","page":"Running the model","title":"ModelOptions","text":"\"\"\"\n    ModelOptions <: AbstractModelOptions\n\nStructure that contains model options.\n\nAvailable options:\n- `SoilBiogeochemistry`: Enable soil biogeochemistry module. Corresponds to\n    `OPT_SoilBiogeochemistry` in the original MATLAB code.\n- `SoilTemperature`: Enable more detailed soil temperature calculation. Corresponds to\n    `OPT_SoilTemp` in the original MATLAB code.\n- `EnvLimitGrowth`: Enable environmental limitation on growth. Corresponds to `OPT_EnvLimitGrowth` in the\n    original MATLAB code.\n- `VegetationCoverArea`: Enable dynamic vegetation cover area. Corresponds to `OPT_VCA` in the\n    original MATLAB code.\n- `DynamicRootDepth`: Enable dynamic root depth. Corresponds to `OPT_DROOT` in the original\n    MATLAB code.\n- `Wetland`: Enable wetland module. Corresponds to `OPT_WET` in the original MATLAB code.\n- `FreezingSoil`: Enable soil freezing/thawing. Corresponds to `OPT_FR_SOIL` in the original\n    MATLAB code.\n- `VegetationSnowInteractions`: Enable vegetation-snow interactions. Corresponds to\n    `OPT_VegSnow` in the original MATLAB code.\n- `PlantHydraulics`: Enable plant hydraulics. Corresponds to `OPT_PlantHydr` in the original\n    MATLAB code.\n- `AllometricScaling`: Allometric scaling option. Corresponds to `OPT_ALLOME` in the original\n    MATLAB code. Possible values:\n    - 1: Oil palm specific allometry\n    - 2: Generic forest allometry\n    - 3: Placeholder for specific forest types (allometry not implemented)\n    - 4: Eucalyptus Regnans specific allometry\n- `MinSPD`: Minimum snowpack depth to have a multilayer snow [m]. Corresponds to\n    `OPT_min_SPD` in the original MATLAB code.\n- `OPT_ST`: parameters for the zero-finding algorithm in the calculation of the surface\n    temperature in the one layer situation\n- `OPT_ST2`: parameters for zero-finding algorithm in the calculation of the surface\n    temperature in the two layer situation\n- `OPT_CR`: parameters for the zero-finding algorithm in the calculation of canopy\nresistance\n- `OPT_SM`: parameters for the ODE solver of the soil moistures\n- `OPT_VD`: parameters for the ODE solver of the vegetation dynamics\n- `OPT_PH`: parameters for the ODE solver of the plant hydraulics\n\nNotes:\n- `OPT_STh` is not implemented, as the code is never reached in the original MATLAB code due to\n    `OPZ_SOLV` being hard-coded to 1\n\"\"\"\n\nOPT_ST, OPT_ST2, OPT_CR are of type ZeroFindingOptions, while OPT_SM, OPT_VD, and OPT_PH are of type ODEOptions, both detailed below.","category":"section"},{"location":"03-model/#ZeroFindingOptions","page":"Running the model","title":"ZeroFindingOptions","text":"\"\"\"\n    ZeroFindingOptions <: AbstractZeroFindingOptions\n\n# Fields\n- `method::Roots.AbstractUnivariateZeroMethod`: Method for root finding (default: `Roots.Order0()`)\n- `xatol::AbstractFloat`: Absolute tolerance for the root finding (default: method-dependent)\n- `xrtol::AbstractFloat`: Relative tolerance for the root finding (default: method-dependent)\n- `atol::AbstractFloat`: Absolute tolerance for the function value (default: method-dependent)\n- `rtol::AbstractFloat`: Relative tolerance for the function value (default: method-dependent)\n- `maxiters::Int`: Maximum number of iterations (default: method-dependent)\n\"\"\"","category":"section"},{"location":"03-model/#ODEOptions","page":"Running the model","title":"ODEOptions","text":"\"\"\"\n    ODEOptions <: AbstractODEOptions\n\n# Fields\n- `abstol::AbstractFloat`: Absolute tolerance for the ODE solver (default: 1e-6)\n- `reltol::AbstractFloat`: Relative tolerance for the ODE solver (default: 1e-3)\n\n# Notes\nThe default values for the absolute and relative tolerances are chosen to replicate the\nbehavior of the MATLAB [`odeset`](https://ch.mathworks.com/help/matlab/ref/odeset.html#d126e1217941) defaults.\n\"\"\"\n\n","category":"section"},{"location":"90-contributing/#contributing","page":"Contributing","title":"Contributing guidelines","text":"First of all, thanks for the interest!\n\nWe welcome all kinds of contribution, including, but not limited to code, documentation, examples, configuration, issue creating, etc.\n\nBe polite and respectful, and follow the code of conduct.","category":"section"},{"location":"90-contributing/#Bug-reports-and-discussions","page":"Contributing","title":"Bug reports and discussions","text":"If you think you found a bug, feel free to open an issue. Focused suggestions and requests can also be opened as issues. Before opening a pull request, start an issue or a discussion on the topic, please.","category":"section"},{"location":"90-contributing/#Working-on-an-issue","page":"Contributing","title":"Working on an issue","text":"If you found an issue that interests you, comment on that issue what your plans are. If the solution to the issue is clear, you can immediately create a pull request (see below). Otherwise, say what your proposed solution is and wait for a discussion around it.\n\ntip: Tip\nFeel free to ping us after a few days if there are no responses.\n\nIf your solution involves code (or something that requires running the package locally), check the developer documentation. Otherwise, you can use the GitHub interface directly to create your pull request.","category":"section"},{"location":"06-flow/#flow","page":"Flow overview","title":"Simulation flow","text":"Running a simulation with the TethysChloris.jl model involves several steps:","category":"section"},{"location":"06-flow/#Cloning-the-repository","page":"Flow overview","title":"Cloning the repository","text":"Follow the instructions in the Installing TethysChloris.jl section to clone the repository to your local machine.","category":"section"},{"location":"06-flow/#Create-a-folder-structure","page":"Flow overview","title":"Create a folder structure","text":"Create a folder structure for your simulation, containing the forcing data as MAT file(s), an outputs folder, and a scripts folder for your Julia scripts. For example:\n\n/path/to/simulation/\n‚îú‚îÄ‚îÄ data/\n‚îÇ   ‚îú‚îÄ‚îÄ forcing.mat \n‚îÇ   ‚îî‚îÄ‚îÄ other_forcing.mat\n‚îú‚îÄ‚îÄ outputs/\n‚îî‚îÄ‚îÄ scripts/\n    ‚îú‚îÄ‚îÄ create_input_files.jl\n    ‚îî‚îÄ‚îÄ run_simulation.jl","category":"section"},{"location":"06-flow/#Add-the-TethysChloris.jl-package-to-your-Julia-environment","page":"Flow overview","title":"Add the TethysChloris.jl package to your Julia environment","text":"using Pkg\nPkg.develop(path=\"/path/to/TethysChloris.jl\")","category":"section"},{"location":"06-flow/#Create-a-Julia-script-to-create-the-NetCDF-and-YAML-file","page":"Flow overview","title":"Create a Julia script to create the NetCDF and YAML file","text":"Follow a structure similar to the example scripts provided in the TethysChloris.jl repository.","category":"section"},{"location":"06-flow/#Run-the-simulation","page":"Flow overview","title":"Run the simulation","text":"Follow a structure similar to the Zurich and Vaira example scripts provided in the TethysChloris.jl repository.","category":"section"},{"location":"#TethysChloris.jl","page":"Home","title":"TethysChloris.jl","text":"TethysChloris.jl is a Julia implementation of the Tethys-Chloris ecohydrological model for plot scale applications. Tethys-Chloris is a mechanistic model designed to simulate essential components of the hydrologic and carbon cycles, resolving exchanges of energy, water, and CO2 between the land surface and the planetary boundary layer with an hourly time step.\n\nThe original Tethys-Chloris model was developed in MATLAB by Prof. Simone Fatichi.","category":"section"},{"location":"#Contributors","page":"Home","title":"Contributors","text":"<!-- ALL-CONTRIBUTORS-LIST:START - Do not remove or modify this section -->\n<!-- prettier-ignore-start -->\n<!-- markdownlint-disable -->\n<table>\n  <tbody>\n    <tr>\n      <td align=\"center\" valign=\"top\" width=\"14.28%\"><a href=\"https://github.com/hsolleder\"><img src=\"https://avatars.githubusercontent.com/u/9566930?v=4?s=100\" width=\"100px;\" alt=\"H Solleder\"/><br /><sub><b>H Solleder</b></sub></a><br /><a href=\"https://github.com/CHANGE-EPFL/TethysChloris.jl/commits?author=hsolleder\" title=\"Code\">üíª</a> <a href=\"https://github.com/CHANGE-EPFL/TethysChloris.jl/commits?author=hsolleder\" title=\"Documentation\">üìñ</a> <a href=\"#maintenance-hsolleder\" title=\"Maintenance\">üöß</a> <a href=\"https://github.com/CHANGE-EPFL/TethysChloris.jl/pulls?q=is%3Apr+reviewed-by%3Ahsolleder\" title=\"Reviewed Pull Requests\">üëÄ</a> <a href=\"https://github.com/CHANGE-EPFL/TethysChloris.jl/commits?author=hsolleder\" title=\"Tests\">‚ö†Ô∏è</a></td>\n      <td align=\"center\" valign=\"top\" width=\"14.28%\"><a href=\"https://github.com/sphamba\"><img src=\"https://avatars.githubusercontent.com/u/17217484?v=4?s=100\" width=\"100px;\" alt=\"Son Pham-Ba\"/><br /><sub><b>Son Pham-Ba</b></sub></a><br /><a href=\"https://github.com/CHANGE-EPFL/TethysChloris.jl/pulls?q=is%3Apr+reviewed-by%3Asphamba\" title=\"Reviewed Pull Requests\">üëÄ</a> <a href=\"#projectManagement-sphamba\" title=\"Project Management\">üìÜ</a></td>\n      <td align=\"center\" valign=\"top\" width=\"14.28%\"><a href=\"https://github.com/QuentinEschmann\"><img src=\"https://avatars.githubusercontent.com/u/86717822?v=4?s=100\" width=\"100px;\" alt=\"Quentin Eschmann\"/><br /><sub><b>Quentin Eschmann</b></sub></a><br /><a href=\"https://github.com/CHANGE-EPFL/TethysChloris.jl/commits?author=QuentinEschmann\" title=\"Tests\">‚ö†Ô∏è</a> <a href=\"#data-QuentinEschmann\" title=\"Data\">üî£</a></td>\n    </tr>\n  </tbody>\n</table>\n\n<!-- markdownlint-restore -->\n<!-- prettier-ignore-end -->\n\n<!-- ALL-CONTRIBUTORS-LIST:END -->","category":"section"},{"location":"05-saving/#saving","page":"Saving the results","title":"Saving the simulation results","text":"After running a simulation with the TethysChloris.jl model, you may want to save the results for future analysis or sharing. The package provides a save function to export the inputs and outputs to a (compressible) zip file. This file will contain\n\nthe input YAML file\nthe input NetCDF forcing file\nthe simulation results as a NetCDF file.\n\nsave(model, \"path/to/outputs.zip\"; compress = true)","category":"section"},{"location":"05-saving/#Specifying-variables-to-save","page":"Saving the results","title":"Specifying variables to save","text":"By default, the save function will store all the available output variables in the NetCDF results file. However, you can specify a subset of variables to save by providing a list of variable names using the outputs keyword argument. For example, to save only the variables \"LAI_L\" and \"Vice\", you can use:\n\nsave(model, \"path/to/outputs.zip\"; outputs = [\"LAI_L\", \"Vice\"], compress = true)","category":"section"},{"location":"92-debugging/#debugging","page":"Debugging","title":"Debugging","text":"Debugging TethysChloris.jl can be challenging due to the complexity of the model and the interactions between its various components. Here are some strategies and tools that can help you identify and fix issues in your simulations.","category":"section"},{"location":"92-debugging/#Visualizing-the-results","page":"Debugging","title":"Visualizing the results","text":"First and foremost, use the built-in plotting functions in the Figures submodule to visualize the results of your simulations. This can help you identify any unexpected behavior or trends in the data.","category":"section"},{"location":"92-debugging/#Comparing-the-Julia-results-with-MATLAB","page":"Debugging","title":"Comparing the Julia results with MATLAB","text":"If you have access to the original MATLAB implementation of the TethysChloris model, you can compare the results obtained from the Julia version with those from MATLAB. This can help you identify discrepancies and potential issues in the Julia implementation. Simply export the results from the MATLAB model as a .mat file at the end of the simulation, with the save function, before comparing the outputs with those from the Julia model.\n\nusing MAT\nmat_data = matread(\"matlab_results.mat\")\n\nfunction plot_differences(matlab_variable, julia_variable, NNv)\n    plot(\n        NNv,\n        [\n            matlab_variable[NNv],\n            julia_variable[NNv],\n            matlab_variable[NNv] - julia_variable[NNv]\n        ],\n        label = [\"MATLAB\" \"Julia\" \"Difference\"],\n        color = [:blue :red :green],\n        grid = true,\n    )\nend\n\nplot_differences(\n    matlab_data[\"LAI_L\"],\n    model.auxiliary.vegetation.low.LAI,\n    1:NNd,\n)\n\nYou can create similar plots for other variables of interest. For example, to compare the biomass of low vegetation, with one plot per pool:\n\nNk = NNd\nP = Vector{Any}(undef, 8)\nfor k = 1:8\n    P[k] = plot(\n        1:Nk,\n        [\n          matlab_data[\"B_L\"][1:Nk, 1, k], \n          model.state.vegetation.low.B[1:Nk, 1, k], \n          matlab_data[\"B_L\"][1:Nk, 1, k] - model.state.vegetation.low.B[1:Nk, 1, k]\n        ],\n        label = [\"MATLAB\" \"Julia\", \"Difference\"],\n        color = [:blue :red :green],\n        grid = true,\n    )\nend\n\nplot(P..., layout = (2, 4), size = (1600, 800))","category":"section"},{"location":"92-debugging/#Using-a-Debugger","page":"Debugging","title":"Using a Debugger","text":"For more in-depth debugging, you can use a Julia debugger such as Debugger.jl. This package provides an interface for stepping through your code, inspecting variables, and evaluating expressions in the context of your running program.\n\nOnce installed, you can use it in your code as follows:\n\nusing Debugger\n\n@enter your_function(args)\n\nAlternatively, you can set breakpoints in the TethysChloris.jl source code and use the @run macro to start the debugger:\n\nimport TethysChloris\nusing Debugger\n\nbreakpoint(TethysChloris.ModuleName.FunctionName, line_number)\n@run your_function(args)\n\nHowever, using the Debugger.jl is limited for the following reasons:\n\nThe model runs several ODE solvers or minimization routines, which are not easily stepped through and can be extremely time-consuming, as Debugger.jl stores the entire stack trace.\nEach function requires a large number of arguments, which makes it difficult to recreate a simple test case\n\nTo avoid the first issue, more lightweight debugging tools such as Infiltrator.jl can be helpful. Infiltrator.jl allows you to \"infiltrate\" a running Julia process and inspect its state without the overhead of a full debugger.","category":"section"},{"location":"92-debugging/#Printing-intermediate-results","page":"Debugging","title":"Printing intermediate results","text":"Another simple but effective debugging strategy is to add print statements throughout the source code to track the flow of execution and the values of key variables. This can help identify where things are going wrong and what might be causing the issue and has been one of the most time-efficient ways to debug the code so far. This approach, however, requires the user to clone the repository and modify the source code directly.","category":"section"},{"location":"92-debugging/#Integrating-MATLAB-results-for-debugging","page":"Debugging","title":"Integrating MATLAB results for debugging","text":"If you have access to the MATLAB results, you can integrate them into the Julia debugging process by loading the MATLAB .mat files directly into your Julia environment using the MAT.jl package, and then setting the model variable of interest to the corresponding MATLAB data over the simulation period. This allows you to isolate and test specific components of the model against known good data. In addition, you should disable the state saving functionality by commenting it out to avoid overwriting the MATLAB results during the simulation.","category":"section"},{"location":"92-debugging/#Identifying-coverage-gaps","page":"Debugging","title":"Identifying coverage gaps","text":"After running a simulation with TethysChloris.jl, you can identify which parts of the model were exercised but were not covered by tests. This is useful for improving test coverage and ensuring that all parts of the model are adequately tested. You can use the generate_coverage_report function to create a coverage report for your simulation script. These functions are located in the tools folder of the TethysChloris.jl repository.\n\n# Generate coverage report for the simulation run\ngenerate_coverage_report(\"zurich_example.jl\", \"zurich_coverage\")\n\n# Generate coverage report for the test suite\ngenerate_test_coverage_report(\"test_coverage\")\n\nOnce the coverage reports are generated, you can compare the two reports using coverage_diff to identify gaps in test coverage.\n\n# Compare coverage reports to identify elements covered in the simulation but not in tests\ncoverage_diff(\"test_coverage\", \"zurich_coverage\")","category":"section"}]
}
